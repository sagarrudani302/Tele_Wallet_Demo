<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send TON Transaction</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.56/dist/tonweb.min.js"></script>
    <style>
        .btn {
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .input-field {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .address-display {
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Connect Wallet & Send TON Transaction</h2>

        <button id="connect-wallet-button" class="btn">Connect Wallet</button>
        <button id="disconnect-wallet-button" class="btn" style="display:none;">Disconnect Wallet</button>

        <div id="wallet-address" class="address-display" style="display:none;"></div>

        <input type="text" id="recipient-address" class="input-field" placeholder="Recipient Address">
        <input type="number" id="transaction-amount" class="input-field" placeholder="Amount in TON">

        <button id="send-transaction-button" class="btn">Send Transaction</button>

        <div id="transaction-feedback"></div>
    </div>
    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://greensoilorganic.com/wow/wow-telegram-wallet.json', // Replace with your app's manifest URL
        });
        // Function to get user-friendly TON address
        async function getTonAddress(userFriendly = true) {
            const wallet = tonConnectUI.wallet;

            if (wallet) {
                const address = wallet.account.address;
                const chain = wallet.account.chain;

                // If userFriendly is true, convert to friendly address
                return userFriendly
                    ? TON_CONNECT_UI.toUserFriendlyAddress(address, chain === TON_CONNECT_UI.CHAIN.TESTNET)
                    : address;
            } else {
                return '';
            }
        }

        const connectWalletButton = document.getElementById('connect-wallet-button');
        const disconnectWalletButton = document.getElementById('disconnect-wallet-button');
        const sendTransactionButton = document.getElementById('send-transaction-button');
        const recipientAddressInput = document.getElementById('recipient-address');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const feedbackDiv = document.getElementById('transaction-feedback');
        const walletAddressDiv = document.getElementById('wallet-address');

        // Function to check if the wallet is already connected
        async function checkWalletConnection() {
            const isConnected = tonConnectUI.wallet; // Check if wallet is connected

            if (isConnected) {
                const walletAddress = tonConnectUI.wallet.account.address; // Get wallet address

                const tonAddress = await getTonAddress();
                console.log('User TON Address:', tonAddress);

                // Display the processed address
                walletAddressDiv.innerText = `Connected: ${tonAddress}`;
                walletAddressDiv.style.display = 'block';
                connectWalletButton.style.display = 'none';
                disconnectWalletButton.style.display = 'inline-block';
            } else {
                connectWalletButton.style.display = 'inline-block';
                disconnectWalletButton.style.display = 'none';
            }
        }

        // Function to connect wallet
        async function connectWallet() {
            try {
                await disconnectWallet();
                await tonConnectUI.connectWallet(); // Connect wallet
                checkWalletConnection(); // Check connection status
            } catch (error) {
                console.error('Error connecting wallet:', error);
                feedbackDiv.innerHTML = '<p class="error">Error connecting wallet. Please try again.</p>';
            }
        }

        // Function to disconnect wallet
        async function disconnectWallet() {
            try {
                await tonConnectUI.disconnect(); // Disconnect wallet
                walletAddressDiv.style.display = 'none';
                connectWalletButton.style.display = 'inline-block';
                disconnectWalletButton.style.display = 'none';
            } catch (error) {
                console.error('Error disconnecting wallet:', error);
                feedbackDiv.innerHTML = '<p class="error">Error disconnecting wallet. Please try again.</p>';
            }
        }

        // Function to send transaction
        async function sendTransaction() {
            const recipientAddress = recipientAddressInput.value;
            const amountInTon = transactionAmountInput.value;

            if (!recipientAddress || !amountInTon) {
                feedbackDiv.innerHTML = '<p class="error">Please fill in both fields!</p>';
                return;
            }

            const amountInNanotons = amountInTon * 1e9;

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600,
                messages: [
                    {
                        address: recipientAddress,
                        amount: amountInNanotons.toString(),
                    }
                ],
            };

            try {
                const result = await tonConnectUI.sendTransaction(transaction);

                console.log('result', result);
                console.log('transactionHash', getTransactionHash(result.boc));

            } catch (error) {
                console.error('Error sending transaction:', error);
                let errorMessage = '';

                if (error.message.includes('insufficient')) {
                    errorMessage = 'Insufficient funds. Please check your balance.';
                } else if (error.message.includes('cancel')) {
                    errorMessage = 'Transaction was cancelled.';
                } else {
                    errorMessage = 'Error sending transaction. Please try again.';
                }

                feedbackDiv.innerHTML = `<p class="error">${errorMessage}</p>`;
            }
        }

        // Initialize tonweb
        const tonweb = new TonWeb();

        // Function to convert BOC to hash
        async function getTransactionHash(bocString) {
            try {
                // Convert BOC string from base64 to bytes
                const bocCell = tonweb.boc.Cell.oneFromBoc(tonweb.utils.base64ToBytes(bocString));

                // Calculate the hash of the BOC cell
                const msgHash = await bocCell.hash(); // Await the hash calculation

                // Convert the hash to base64 format
                const YOUR_MSG_HASH = tonweb.utils.bytesToBase64(msgHash);

                console.log("Msg Hash:", YOUR_MSG_HASH);

                feedbackDiv.innerHTML = `<p class="success">Transaction sent successfully! Transaction hash: ${YOUR_MSG_HASH}</p>`;
            } catch (error) {
                console.error("Error calculating hash:", error);
            }
        }

        // Call the function with your BOC string
        getTransactionHash('te6cckEBAgEAqQAB4YgB2QIJE36BEKr10ORWqoVTVjJTpAMWcg3bfseL86ACVqgAS6fpFX8EkBeZiK0gspqy4jOaNZyU9bqOnh1gIPjlOZVO42WFujQcvj5Jhx5ZsVix4KA0H4x2YL+YF5aTvOsgUU1NGLs4aQHYAAAAsAAcAQBmQgB2QIJE36BEKr10ORWqoVTVjJTpAMWcg3bfseL86ACVqhzEtAAAAAAAAAAAAAAAAAAANqEYKw==');

        connectWalletButton.addEventListener('click', connectWallet);
        disconnectWalletButton.addEventListener('click', disconnectWallet);
        sendTransactionButton.addEventListener('click', sendTransaction);

        // Check wallet connection on page load
        window.addEventListener('load', checkWalletConnection);
    </script>

</body>

</html>